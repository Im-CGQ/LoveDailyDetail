# 媒体文件信息存储更新说明

## 概述
本次更新将背景音乐、图片和视频的存储方式进行了优化，现在会存储更详细的文件信息，包括文件名、宽高、时长等。

## 主要修改

### 1. 数据库结构更新

#### 新增表
- `background_music` - 背景音乐表
  - `id` - 主键
  - `music_url` - 音乐文件URL
  - `file_name` - 文件名
  - `title` - 音乐标题
  - `artist` - 艺术家
  - `duration` - 时长（秒）
  - `created_at` - 创建时间
  - `updated_at` - 更新时间

#### 修改表
- `diary_images` - 添加字段
  - `id` - 主键（新增）
  - `file_name` - 文件名（新增）
  - `width` - 图片宽度（新增）
  - `height` - 图片高度（新增）

- `diary_videos` - 添加字段
  - `id` - 主键（新增）
  - `file_name` - 文件名（新增）
  - `width` - 视频宽度（新增）
  - `height` - 视频高度（新增）

- `diary_background_music` - 新增表
  - `id` - 主键
  - `diary_id` - 日记ID外键
  - `music_url` - 音乐文件URL
  - `file_name` - 文件名
  - `title` - 音乐标题
  - `artist` - 艺术家
  - `duration` - 时长（秒）

- `diaries` - 移除字段
  - 移除 `background_music_url` 字段

### 2. 后端代码更新

#### 新增实体类
- `ImageInfo.java` - 图片信息实体
- `VideoInfo.java` - 视频信息实体
- `DiaryBackgroundMusic.java` - 日记背景音乐实体

#### 新增DTO类
- `ImageInfoDTO.java` - 图片信息传输对象
- `VideoInfoDTO.java` - 视频信息传输对象
- `DiaryBackgroundMusicDTO.java` - 日记背景音乐传输对象

#### 新增Repository
- `ImageInfoRepository.java`
- `VideoInfoRepository.java`
- `DiaryBackgroundMusicRepository.java`

#### 修改的类
- `Diary.java` - 使用新的实体关系
- `DiaryDTO.java` - 使用新的DTO结构
- `DiaryServiceImpl.java` - 更新创建和更新逻辑

### 3. 前端代码更新

#### 修改的文件
- `CreateDiary.vue` - 添加获取文件尺寸和时长的功能

#### 新增功能
- 图片上传时自动获取宽高
- 视频上传时自动获取宽高
- 音乐上传时自动获取时长
- 提交时包含完整的文件信息

## 执行步骤

### 1. 数据库更新
对于新安装的系统，直接使用更新后的 `database/init.sql` 脚本初始化数据库。

对于现有系统，执行 `database/update_media_info.sql` 脚本：
```sql
-- 更新日记图片表，添加文件名、宽高信息
ALTER TABLE diary_images 
ADD COLUMN file_name VARCHAR(255) NOT NULL DEFAULT '',
ADD COLUMN width INT NULL,
ADD COLUMN height INT NULL;

-- 更新日记视频表，添加文件名、宽高信息
ALTER TABLE diary_videos 
ADD COLUMN file_name VARCHAR(255) NOT NULL DEFAULT '',
ADD COLUMN width INT NULL,
ADD COLUMN height INT NULL;

-- 为diary_images表添加主键
ALTER TABLE diary_images 
ADD COLUMN id BIGINT AUTO_INCREMENT PRIMARY KEY FIRST;

-- 为diary_videos表添加主键
ALTER TABLE diary_videos 
ADD COLUMN id BIGINT AUTO_INCREMENT PRIMARY KEY FIRST;

-- 创建背景音乐表
CREATE TABLE background_music (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    music_url VARCHAR(500) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    title VARCHAR(255) NULL COMMENT '音乐标题',
    artist VARCHAR(255) NULL COMMENT '艺术家',
    duration INT NULL COMMENT '时长（秒）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 更新日记表，添加背景音乐ID外键
ALTER TABLE diaries 
ADD COLUMN background_music_id BIGINT NULL,
ADD FOREIGN KEY (background_music_id) REFERENCES background_music(id) ON DELETE SET NULL;

-- 更新现有数据，将URL中的文件名提取到file_name字段
UPDATE diary_images 
SET file_name = SUBSTRING_INDEX(image_url, '/', -1)
WHERE file_name = '';

UPDATE diary_videos 
SET file_name = SUBSTRING_INDEX(video_url, '/', -1)
WHERE file_name = '';

-- 将现有的背景音乐数据迁移到新表
INSERT INTO background_music (music_url, file_name, title, created_at)
SELECT DISTINCT 
    background_music_url,
    SUBSTRING_INDEX(background_music_url, '/', -1) as file_name,
    SUBSTRING_INDEX(SUBSTRING_INDEX(background_music_url, '/', -1), '.', 1) as title,
    NOW()
FROM diaries 
WHERE background_music_url IS NOT NULL;

-- 更新日记表，设置背景音乐ID
UPDATE diaries d
JOIN background_music bm ON d.background_music_url = bm.music_url
SET d.background_music_id = bm.id
WHERE d.background_music_url IS NOT NULL;
```

### 2. 重新编译后端
```bash
cd backend
mvn clean compile
```

### 3. 重启服务
重启后端和前端服务以应用更改。

## 数据格式

### 图片信息
```json
{
  "imageUrl": "https://example.com/image.jpg",
  "fileName": "image.jpg",
  "width": 1920,
  "height": 1080
}
```

### 视频信息
```json
{
  "videoUrl": "https://example.com/video.mp4",
  "fileName": "video.mp4",
  "width": 1920,
  "height": 1080
}
```

### 背景音乐信息
```json
[
  {
    "musicUrl": "https://example.com/music.mp3",
    "fileName": "music.mp3",
    "title": "背景音乐",
    "artist": null,
    "duration": 180
  }
]
```

## 注意事项

1. **新安装系统**：直接使用更新后的 `database/init.sql` 脚本初始化数据库
2. **现有系统**：执行 `database/update_media_info.sql` 脚本进行数据迁移
3. 数据库更新脚本会保留现有的背景音乐URL字段，以确保向后兼容
4. 新的上传功能会自动获取文件尺寸和时长信息
5. 现有的日记数据会被自动迁移到新的表结构中
6. 建议在测试环境中先验证所有功能正常后再部署到生产环境
7. 可以使用 `database/test_structure.sql` 脚本验证数据库结构是否正确
