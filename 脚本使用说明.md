# LoveDailyDetail 项目脚本使用说明

## 脚本列表

### 数据库管理脚本
- `init-database.sh` - 初始化数据库
- `backup-database.sh` - 备份数据库
- `commit-backup.sh` - 提交备份到git

### 部署脚本
- `deploy-backend.sh` - 部署后端服务
- `deploy-frontend.sh` - 部署前端服务

## 权限设置

### Linux/Mac 系统
```bash
# 给所有脚本添加执行权限
chmod +x init-database.sh
chmod +x backup-database.sh
chmod +x commit-backup.sh
chmod +x deploy-backend.sh
chmod +x deploy-frontend.sh

# 或者一次性设置所有脚本权限
chmod +x *.sh
```

### Windows 系统
```powershell
# PowerShell 中设置执行权限
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 或者使用 Git Bash
chmod +x *.sh
```

## 运行命令

### 1. 首次部署（完整流程）

```bash
# 1. 初始化数据库
./init-database.sh

# 2. 部署后端服务
./deploy-backend.sh

# 3. 部署前端服务
./deploy-frontend.sh
```

### 2. 数据库备份和版本控制

```bash
# 1. 创建数据库备份
./backup-database.sh

# 2. 提交备份到git并推送到远程
./commit-backup.sh
```

### 3. 单独操作

```bash
# 仅初始化数据库
./init-database.sh

# 仅备份数据库
./backup-database.sh

# 仅提交备份到git
./commit-backup.sh

# 仅部署后端
./deploy-backend.sh

# 仅部署前端
./deploy-frontend.sh
```

## 脚本功能说明

### init-database.sh
- 启动MySQL 8.0容器
- 创建 `love_diary` 数据库
- 执行 `database/init.sql` 初始化脚本
- 创建所有表结构和初始数据
- 显示数据库状态信息

### backup-database.sh
- 检查MySQL容器状态
- 创建数据库完整备份
- 备份文件保存到 `./database/backups/`
- 文件名格式：`backup_YYYYMMDD_HHMMSS.sql`

### commit-backup.sh
- 检查git仓库状态
- 查找备份文件
- 提交备份文件到本地git
- 推送到远程仓库
- 显示提交结果

### deploy-backend.sh
- Git操作：暂存当前修改并拉取最新代码
- 复制配置文件
- 停止旧容器
- 重新构建后端项目
- 构建Docker镜像
- 启动新容器（端口9999）

### deploy-frontend.sh
- Git操作：暂存当前修改并拉取最新代码
- 进入frontend目录
- 安装npm依赖
- 构建前端项目
- 停止旧容器
- 构建Docker镜像
- 启动新容器（端口80）

## 注意事项

1. **首次使用**：必须先运行 `init-database.sh` 初始化数据库
2. **Docker要求**：确保已安装Docker和Docker Compose
3. **Git配置**：确保已配置git远程仓库
4. **端口占用**：确保端口80和9999未被占用
5. **权限问题**：确保有足够的权限执行Docker和git命令

## 文件结构

```
LoveDailyDetail/
├── database/
│   ├── init.sql
│   ├── update.sql
│   └── backups/
│       └── backup_*.sql
├── backend/
├── frontend/
├── init-database.sh
├── backup-database.sh
├── commit-backup.sh
├── deploy-backend.sh
├── deploy-frontend.sh
└── 脚本使用说明.md
```

## 故障排除

### 常见问题

1. **权限被拒绝**
   ```bash
   chmod +x *.sh
   ```

2. **Docker容器启动失败**
   ```bash
   docker ps -a
   docker logs <容器名>
   ```

3. **数据库连接失败**
   ```bash
   docker exec -it mysql-latest mysql -uroot -p123456
   ```

4. **Git推送失败**
   ```bash
   git remote -v
   git push origin main
   ```

## 联系信息

如有问题，请检查：
1. Docker服务是否正常运行
2. 网络连接是否正常
3. 端口是否被占用
4. 权限是否足够
