# 前端媒体展示结构更新说明

## 概述
本次更新将前端媒体展示逻辑调整为适配新的数据结构，确保图片、视频和背景音乐能够正确显示。

## 主要修改

### 1. 日记详情页面 (Detail.vue)

#### 图片展示
- **修改前**: `diary.images[index]` (直接使用URL字符串)
- **修改后**: `diary.images[index].imageUrl` (使用对象结构)

```vue
<!-- 修改前 -->
<img :src="image" class="image" @click="previewImage(index)" />

<!-- 修改后 -->
<img :src="image.imageUrl" class="image" @click="previewImage(index)" />
```

#### 视频展示
- **修改前**: `diary.videos[index]` (直接使用URL字符串)
- **修改后**: `diary.videos[index].videoUrl` (使用对象结构)

```vue
<!-- 修改前 -->
<video :src="video" class="video-player" />

<!-- 修改后 -->
<video :src="video.videoUrl" class="video-player" />
```

#### 背景音乐展示
- **修改前**: `diary.backgroundMusic` (单个对象或字符串)
- **修改后**: `diary.backgroundMusic[0].musicUrl` (数组结构)

```vue
<!-- 修改前 -->
<div v-if="diary && diary.backgroundMusic">

<!-- 修改后 -->
<div v-if="diary && diary.backgroundMusic && diary.backgroundMusic.length > 0">
```

#### 音乐播放器初始化
```javascript
// 修改前
audioElement = new Audio(diary.value.backgroundMusic)

// 修改后
audioElement = new Audio(diary.value.backgroundMusic[0].musicUrl)
```

#### 图片预览功能
```javascript
// 修改前
showImagePreview({
  images: diary.value.images,
  startPosition: index
})

// 修改后
const imageUrls = diary.value.images.map(image => image.imageUrl)
showImagePreview({
  images: imageUrls,
  startPosition: index
})
```

### 2. 日记列表页面 (DiaryList.vue)

#### 媒体标记显示
```vue
<!-- 修改前 -->
<div v-if="diary.backgroundMusic" class="media-badge music-badge">

<!-- 修改后 -->
<div v-if="diary.backgroundMusic && diary.backgroundMusic.length > 0" class="media-badge music-badge">
```

#### 图片缩略图显示
```vue
<!-- 修改前 -->
<img :src="diary.images[0]" :alt="diary.title" class="diary-image" />

<!-- 修改后 -->
<img :src="diary.images[0].imageUrl" :alt="diary.title" class="diary-image" />
```

#### 图片预览功能
```javascript
// 修改前
showImagePreview({
  images: images,
  startPosition: 0
})

// 修改后
const imageUrls = images.map(image => image.imageUrl)
showImagePreview({
  images: imageUrls,
  startPosition: 0
})
```

### 3. 管理员日记列表页面 (admin/DiaryList.vue)

#### 图片缩略图显示
```vue
<!-- 修改前 -->
<img :src="diary.images[0]" :alt="diary.title" class="diary-image" />

<!-- 修改后 -->
<img :src="diary.images[0].imageUrl" :alt="diary.title" class="diary-image" />
```

### 4. 日历页面 (Calendar.vue)

#### 媒体标记显示
```vue
<!-- 修改前 -->
<div v-if="diary.backgroundMusic" class="media-badge music-badge">

<!-- 修改后 -->
<div v-if="diary.backgroundMusic && diary.backgroundMusic.length > 0" class="media-badge music-badge">
```

#### 图片缩略图显示
```vue
<!-- 修改前 -->
<img :src="diary.images[0]" :alt="diary.title" class="diary-image" />

<!-- 修改后 -->
<img :src="diary.images[0].imageUrl" :alt="diary.title" class="diary-image" />
```

#### 图片预览功能
```javascript
// 修改前
showImagePreview({
  images: images,
  startPosition: 0
})

// 修改后
const imageUrls = images.map(image => image.imageUrl)
showImagePreview({
  images: imageUrls,
  startPosition: 0
})
```

#### 背景音乐检查逻辑
```javascript
// 修改前
const hasBackgroundMusicOnDate = (date) => {
  const diariesOnDate = getDiariesOnDate(date)
  return diariesOnDate.some(diary => diary.backgroundMusic && diary.backgroundMusic.trim() !== '')
}

// 修改后
const hasBackgroundMusicOnDate = (date) => {
  const diariesOnDate = getDiariesOnDate(date)
  return diariesOnDate.some(diary => diary.backgroundMusic && diary.backgroundMusic.length > 0)
}
```

### 5. 首页 (Home.vue)

#### 背景音乐播放器显示
```vue
<!-- 修改前 -->
<div v-if="currentDiary && currentDiary.backgroundMusic">

<!-- 修改后 -->
<div v-if="currentDiary && currentDiary.backgroundMusic && currentDiary.backgroundMusic.length > 0">
```

#### 图片轮播显示
```vue
<!-- 修改前 -->
<img :src="image" :alt="`回忆图片 ${index + 1}`" class="memory-image" />

<!-- 修改后 -->
<img :src="image.imageUrl" :alt="`回忆图片 ${index + 1}`" class="memory-image" />
```

#### 视频播放器显示
```vue
<!-- 修改前 -->
<video :src="video" class="video-player" />

<!-- 修改后 -->
<video :src="video.videoUrl" class="video-player" />
```

#### 音乐播放器初始化
```javascript
// 修改前
const initAudio = () => {
  if (!currentDiary.value?.backgroundMusic) return
  audioElement.value = new Audio(currentDiary.value.backgroundMusic)
}

// 修改后
const initAudio = () => {
  if (!currentDiary.value?.backgroundMusic || currentDiary.value.backgroundMusic.length === 0) return
  audioElement.value = new Audio(currentDiary.value.backgroundMusic[0].musicUrl)
}
```

#### 图片预览功能
```javascript
// 修改前
showImagePreview({
  images: currentDiary.value.images,
  startPosition: index
})

// 修改后
const imageUrls = currentDiary.value.images.map(image => image.imageUrl)
showImagePreview({
  images: imageUrls,
  startPosition: index
})
```

#### 视频播放功能
```javascript
// 修改前
const videoUrl = currentDiary.value.videos[index]

// 修改后
const videoUrl = currentDiary.value.videos[index].videoUrl
```

### 6. 编辑日记页面 (admin/EditDiary.vue)

#### 新增辅助函数
```javascript
// 获取图片尺寸
const getImageDimensions = (file) => {
  return new Promise((resolve) => {
    const img = new Image()
    img.onload = () => {
      resolve({
        width: img.naturalWidth,
        height: img.naturalHeight
      })
    }
    img.onerror = () => {
      resolve({ width: 0, height: 0 })
    }
    img.src = URL.createObjectURL(file)
  })
}

// 获取视频尺寸
const getVideoDimensions = (file) => {
  return new Promise((resolve) => {
    const video = document.createElement('video')
    video.onloadedmetadata = () => {
      resolve({
        width: video.videoWidth,
        height: video.videoHeight
      })
    }
    video.onerror = () => {
      resolve({ width: 0, height: 0 })
    }
    video.src = URL.createObjectURL(file)
  })
}

// 获取音乐时长
const getMusicDuration = (file) => {
  return new Promise((resolve) => {
    const audio = new Audio()
    audio.onloadedmetadata = () => {
      resolve(Math.floor(audio.duration))
    }
    audio.onerror = () => {
      resolve(0)
    }
    audio.src = URL.createObjectURL(file)
  })
}
```

#### 文件上传处理更新
```javascript
// 图片上传处理
const processSingleFile = async (file) => {
  // ... 文件验证逻辑 ...
  
  // 获取图片尺寸
  const dimensions = await getImageDimensions(file.file)
  
  const url = await uploadImage(file.file)
  file.url = url
  file.fileName = file.file.name
  file.width = dimensions.width
  file.height = dimensions.height
  file.status = 'done'
  file.message = '上传成功'
}

// 视频上传处理
const processSingleVideo = async (file) => {
  // ... 文件验证逻辑 ...
  
  // 获取视频尺寸
  const dimensions = await getVideoDimensions(file.file)
  
  const url = await uploadVideo(file.file)
  file.url = url
  file.fileName = file.file.name
  file.width = dimensions.width
  file.height = dimensions.height
  file.status = 'done'
  file.message = '上传成功'
}

// 音乐上传处理
const afterMusicRead = async (file) => {
  // ... 文件验证逻辑 ...
  
  // 获取音乐时长
  const duration = await getMusicDuration(file.file)
  
  const url = await uploadMusic(file.file)
  file.url = url
  file.fileName = file.file.name
  file.duration = duration
  file.status = 'done'
  file.message = '上传成功'
}
```

#### 数据提交格式更新
```javascript
const onSubmit = async (values) => {
  const diaryData = {
    title: form.value.title,
    date: form.value.date,
    description: form.value.description,
    images: form.value.images.map(file => ({
      imageUrl: file.url,
      fileName: file.fileName || file.file?.name || 'image.jpg',
      width: file.width || 0,
      height: file.height || 0
    })),
    videos: form.value.videos.map(file => ({
      videoUrl: file.url,
      fileName: file.fileName || file.file?.name || 'video.mp4',
      width: file.width || 0,
      height: file.height || 0
    })),
    backgroundMusic: form.value.backgroundMusic.length > 0 ? [{
      musicUrl: form.value.backgroundMusic[0].url,
      fileName: form.value.backgroundMusic[0].fileName || form.value.backgroundMusic[0].file?.name || 'background_music.mp3',
      title: form.value.backgroundMusic[0].file?.name || '背景音乐',
      artist: null,
      duration: form.value.backgroundMusic[0].duration || 0
    }] : []
  }
  
  await updateDiary(form.value.id, diaryData)
}
```

#### 数据加载格式更新
```javascript
const loadDiary = async () => {
  const diary = await getDiaryById(route.params.id)
  if (diary) {
    form.value = {
      id: diary.id,
      title: diary.title,
      date: diary.date,
      description: diary.description,
      images: diary.images ? diary.images.map(image => ({ 
        url: image.imageUrl, 
        fileName: image.fileName,
        width: image.width,
        height: image.height,
        status: 'done' 
      })) : [],
      videos: diary.videos ? diary.videos.map(video => ({ 
        url: video.videoUrl, 
        fileName: video.fileName,
        width: video.width,
        height: video.height,
        status: 'done' 
      })) : [],
      backgroundMusic: diary.backgroundMusic && diary.backgroundMusic.length > 0 ? [{
        url: diary.backgroundMusic[0].musicUrl,
        fileName: diary.backgroundMusic[0].fileName,
        title: diary.backgroundMusic[0].title,
        artist: diary.backgroundMusic[0].artist,
        duration: diary.backgroundMusic[0].duration,
        status: 'done',
        message: '已加载'
      }] : []
    }
  }
}
```

## 数据结构对比

### 图片数据结构
```javascript
// 修改前
diary.images = [
  "https://example.com/image1.jpg",
  "https://example.com/image2.jpg"
]

// 修改后
diary.images = [
  {
    imageUrl: "https://example.com/image1.jpg",
    fileName: "image1.jpg",
    width: 1920,
    height: 1080
  },
  {
    imageUrl: "https://example.com/image2.jpg",
    fileName: "image2.jpg",
    width: 1280,
    height: 720
  }
]
```

### 视频数据结构
```javascript
// 修改前
diary.videos = [
  "https://example.com/video1.mp4",
  "https://example.com/video2.mp4"
]

// 修改后
diary.videos = [
  {
    videoUrl: "https://example.com/video1.mp4",
    fileName: "video1.mp4",
    width: 1920,
    height: 1080
  },
  {
    videoUrl: "https://example.com/video2.mp4",
    fileName: "video2.mp4",
    width: 1280,
    height: 720
  }
]
```

### 背景音乐数据结构
```javascript
// 修改前
diary.backgroundMusic = "https://example.com/music.mp3"
// 或者
diary.backgroundMusic = {
  musicUrl: "https://example.com/music.mp3",
  fileName: "music.mp3"
}

// 修改后
diary.backgroundMusic = [
  {
    musicUrl: "https://example.com/music.mp3",
    fileName: "music.mp3",
    title: "背景音乐",
    artist: null,
    duration: 180
  }
]
```

## 注意事项

1. **数组结构**: 背景音乐现在使用数组结构，需要检查 `length > 0` 来判断是否有音乐
2. **对象属性**: 图片和视频现在使用对象结构，需要访问 `.imageUrl` 和 `.videoUrl` 属性
3. **文件信息**: 上传时会自动获取文件的尺寸和时长信息
4. **向后兼容**: 编辑页面会正确处理新旧数据格式的转换
5. **错误处理**: 如果获取文件信息失败，会使用默认值（0）避免程序崩溃

## 测试建议

1. 测试图片上传和显示功能
2. 测试视频上传和播放功能
3. 测试背景音乐上传和播放功能
4. 测试编辑现有日记的功能
5. 测试图片预览功能
6. 测试媒体标记显示功能
7. 验证文件信息（尺寸、时长）是否正确获取和显示
