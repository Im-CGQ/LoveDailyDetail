# 数据库更新说明：添加分享功能

## 概述
本次更新为系统添加分享功能，允许用户创建有效期3小时的分享链接，无需登录即可查看日记和信件内容。

## 更新内容

### 新增表
1. **diary_share_links** - 日记分享链接表
   - `id`: 主键
   - `diary_id`: 日记ID（外键）
   - `share_token`: 分享令牌（唯一）
   - `expires_at`: 过期时间
   - `created_at`: 创建时间
   - `is_active`: 是否激活

2. **letter_share_links** - 信件分享链接表
   - `id`: 主键
   - `letter_id`: 信件ID（外键）
   - `share_token`: 分享令牌（唯一）
   - `expires_at`: 过期时间
   - `created_at`: 创建时间
   - `is_active`: 是否激活

### 新增索引
- `idx_diary_share_links_token` - 分享令牌索引
- `idx_diary_share_links_diary_id` - 日记ID索引
- `idx_diary_share_links_expires_at` - 过期时间索引
- `idx_letter_share_links_token` - 分享令牌索引
- `idx_letter_share_links_letter_id` - 信件ID索引
- `idx_letter_share_links_expires_at` - 过期时间索引

## 更新步骤

### 1. 备份数据库
```bash
# 备份现有数据库
mysqldump -u root -p love_diary > backup_before_share_feature.sql
```

### 2. 执行更新脚本

#### Linux/Mac 用户
```bash
# 给脚本执行权限
chmod +x update-database.sh

# 执行更新（使用默认参数）
./update-database.sh

# 或指定参数
./update-database.sh localhost 3306 root love_diary
```

#### Windows 用户
```cmd
# 执行更新（使用默认参数）
update-database.bat

# 或指定参数
update-database.bat localhost 3306 root love_diary
```

#### 手动执行SQL
```bash
# 直接执行SQL文件
mysql -u root -p love_diary < database/update_to_share_feature.sql
```

### 3. 验证更新
执行以下SQL查询验证表是否创建成功：
```sql
-- 查看新增的表
SHOW TABLES LIKE '%share_links%';

-- 查看表结构
DESCRIBE diary_share_links;
DESCRIBE letter_share_links;

-- 查看索引
SHOW INDEX FROM diary_share_links;
SHOW INDEX FROM letter_share_links;
```

## 注意事项

1. **备份重要**: 执行更新前请务必备份数据库
2. **维护时间**: 建议在系统维护时间执行更新
3. **权限要求**: 确保数据库用户有创建表和索引的权限
4. **版本兼容**: 确保MySQL版本支持使用的SQL语法

## 回滚方案

如果更新出现问题，可以执行以下SQL回滚：
```sql
-- 删除新增的表（会同时删除相关索引）
DROP TABLE IF EXISTS diary_share_links;
DROP TABLE IF EXISTS letter_share_links;
```

## 功能说明

### 分享功能特性
- **3小时有效期**: 分享链接在创建后3小时自动过期
- **无需登录**: 任何人都可以通过分享链接查看内容
- **安全机制**: 使用唯一token，过期后自动失效
- **一键复制**: 点击分享按钮自动复制链接到剪贴板

### API接口
- `POST /share/create/{diaryId}` - 创建日记分享链接
- `GET /share/diary/{shareToken}` - 查看分享的日记
- `POST /share/letter/create/{letterId}` - 创建信件分享链接
- `GET /share/letter/{shareToken}` - 查看分享的信件

### 前端页面
- `/share/diary/:shareToken` - 日记分享查看页面
- `/share/letter/:shareToken` - 信件分享查看页面

## 联系支持

如果在更新过程中遇到问题，请联系技术支持。
